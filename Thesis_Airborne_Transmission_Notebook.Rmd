---
title: "Thesis_Airborne_Transmission"
output: html_notebook
---

Install packages and open libraries as needed
```{r Install packages and libraries needed}
# install.packages("tidyverse")
# install.packages("RCurl") # Pull data from Github Raw version 
# install.packages("sensitivity")
# install.packages("ggplot2")
# install.packages("readxl")
# install.packages("reshape2")
library(readxl)
library(deSolve)
library(data.table)
library(data.table)
library(ODEsensitivity)# If you want to use the s
library(ggplot2)
library(plotly)
library(lattice)#Making heat maps
library(latticeExtra) #make Heat maps
library(ggplot2)
library (RCurl)
library (reshape2)
```

Insert Data for parameters. Most can be used as a guide on what to use for different scenarios. Importing CSV files but see excel files for sources (https://github.com/copelaa/Airborne_Droplet_Transmission_CopelandThesis/tree/master/Data).

CSV files hosted on github and can be manually downloaded and opened from local machine, or pulled directly from Github. 
```{r Input Data Tables From GitHub}
##Risk per distance (R)if D=x
Risk_factor = "https://raw.githubusercontent.com/copelaa/Airborne_Droplet_Transmission_CopelandThesis/master/Data/Room%20Info.csv"

Risk_factor <- read.csv(Risk_factor)

##Quanta of virus (q)
Virus_Quanta = "https://raw.githubusercontent.com/copelaa/Airborne_Droplet_Transmission_CopelandThesis/master/Data/Virus%20Quanta.csv"

Virus_Quanta=read.csv(Virus_Quanta)

##Pulmonary Rate
Pulmonary_Rate = "https://raw.githubusercontent.com/copelaa/Airborne_Droplet_Transmission_CopelandThesis/master/Data/Pulmonary%20rate.csv"

Pulmonary_Rate = read.csv(Pulmonary_Rate)
Pulmonary_Rate$p_gendermean <- rowMeans(Pulmonary_Rate[,c('Female..m3.hr.', 'Male..m3.hr.')], na.rm=TRUE)

##ACH changes based on Volume and CFM per occupancy type
Ventilation = "https://raw.githubusercontent.com/copelaa/Airborne_Droplet_Transmission_CopelandThesis/master/Data/Ventilation.csv"
Ventilation = read.csv(Ventilation)
```


Build out scenarios you want to Test or compare below I will start with building out a typical **Office** Scenario. Where:
- Typical ventilation rates are used that meet American ASHRAE Code 
- Pulmonary rates for typical working person 21 years old - 61 years old. 
- Quanta is currently estimated for SARS COVID 2 at 100. Other more known quanta are provided with infectious levels varying. 
- Risk factor can be chosen as one point but depending on event we will come up with an estimate later on in chunk {r Risk Factor Estimation}. 
```{r Office Scenerio}

##OFFICE

#Risk set below is is all people were the same distance from the infected source 
Risk <- subset.data.frame(Risk_factor, D ==1.0) 
rownames(Risk)=NULL
Risk <- tibble::column_to_rownames(Risk, "D")
Risk <- Risk$R

#Same as above but using distance 
# distance <- subset.data.frame(Risk_factor, D ==1.0) 
# distance <-tibble::column_to_rownames(distance, "R")
# distance <- distance$D
# distance <-as.numeric(distance)

##Quanta (q)
q <- 100

##Pulmonary rate (p)
p <- subset.data.frame(Pulmonary_Rate, Age == "21-61" & Activity == "SEDENTARY", select = "p_gendermean")
p <- p$p_gendermean
p <-as.numeric(p)

##ACH (a) 
af <- 4 #Air Changes Per Hour
af <- as.numeric(af)

##Volume (V)
Vf <- 226.53 # in meters - Open Office space 1000 sq ft 8ft ceiling height 
Vf <- as.numeric(Vf)

beta_office <-(Risk +((p*q)/(Vf*af)))           # Transmission risk at office space

```

Below is the Airplane scenarios parameters defined: 
- Typical ventilation rates are used that meet American ASHRAE Code 
- Pulmonary rates for typical working person 21 years old - 61 years old. 
- Quanta is currently estimated for SARS COVID 2 at 100. Other more known quanta are provided with infectious levels varying. 
- Risk factor can be chosen as one point but depending on event we will come up with an estimate later on in chunk 'Risk Factor Estimations. **Note** Distance of susceptible persons will be limited to normal Boeing 777-300ER ventilation zones (typically 7 zones in main cabin )
```{r Plane Parameters}

###Plane 
Risk_plane<-.013 # Again using a static distance of 2.0 M or 2.5 M away from infected source

##Quanta (q)
#Same as Office 

##Pulmonary rate (p)
#Same as Office 

##ACH (a)
ap <- 15 # Based on suggested code 15-20 is standard
ap <- as.numeric(ap)

##Volume (V)# ~ 13ft (31 inches per row x 5 rows) x 19 ft. 3 in (Cabin width) x 73In Height Estimated 42.851 meter3 or 1,522ft3
Vp<- 3.937*5.87*1.8542 #in meters
```

As mentioned previously it is not realistic that all susceptible people would be the same distance away from the infected source unless we were only looking at a small subset of persons within an enclosed space. 

In order to find a more realistic risk rate, a random points that correspond with the number of susceptible people will be plotted over a grid of corresponding to the spaces dimensions (height and width)

First Create a function to calculate Risk Based on Distance from Index source:
```{r Calculate Risk based as a function of Distance}
calcRisk <- function(distance){
  if (distance < 1){
    risk <- 0.13
  } else if (distance < 2) {
    risk <- 0.026}
    else {risk <- 0.026/2^(as.integer(distance-1))}
  return(risk)
}
```
Random Cumulative Risk in Office
```{r}
iterations <- 10000
mean_distances_office <-rep(0, iterations)
for(i in 1:iterations){
set.seed(i)
{
  min_x <- 0
  max_x_office <- 10
  min_y <- 0
  max_y_office<- 10
  x_step <- 0.3
  y_step <- 0.3
  x_range <- seq(min_x, max_x_office, x_step)
  y_range <- seq(min_y, max_y_office, y_step)
  num_points_office <- 20 #Number of Susceptible 
  xs = sample(x_range, num_points_office, replace = TRUE, prob = NULL)
  ys = sample(y_range, num_points_office, replace = TRUE, prob = NULL)
  
  #Randomly plot points in office space 
  sample_points_office <- array(c(xs, ys), dim = c(num_points_office, 2))
  
  Distance_infected_source <- sweep(sample_points_office[1:20,1:2],2,sample_points_office[1,1:2])#Finding points distance from Random infected source location (1st point indicated in sample_point_office dataframe)
  mean_distance_office = mean(rowSums(Distance_infected_source^2)^0.5)
  
  mean_distances_office[i] <- mean_distance_office
}
}

ggplot(as.data.frame(sample_points_office), aes(x=xs, y=ys)) +
  
  geom_point(size=2, shape=23, col='red') #Plot Location of People

#Find Risk associated with Distance
Cumalitve_risk_office<- as.numeric(lapply(mean_distances_office], calcRisk))
Cumalitve_risk_office<- sum(Cumalitve_risk_office)/20
Cumalitve_distance_office<- mean(sample_points_df_school$distance_from_index)
```

Random Cumulative Risk in Plane
```{r Risk Factor Estimation - Plane}
## Random points in a grid

set.seed(123)#To get same points and results every time you run it
{
min_x <- 0
max_x_plane <- 4 #Length in M
min_y <- 0
max_y_plane <- 6 #Width in M
x_step <- 0.3
y_step <- 0.3
x_range <- seq(min_x, max_x_plane, x_step)
y_range <- seq(min_y, max_y_plane, y_step)
num_points_plane <- 10 #Number of Susceptible people
xp = sample(x_range, num_points_plane, replace = TRUE, prob = NULL)
yp = sample(y_range, num_points_plane, replace = TRUE, prob = NULL)
sample_points_plane <- array(c(xp, yp), dim = c(num_points_plane, 2))}
ggplot(as.data.frame(sample_points_plane), aes(x=xp, y=yp)) +
  
  geom_point(size=2, shape=23, col='red')

#Get points in dataframe and calculate corresponding Risk 
xp<- melt(xp, c('X'))
yp<- melt(yp,c('Y'))
id_plane<- seq(1:nrow(yp))
yp<- cbind(id_plane=id_plane, yp)
xp<- cbind(id_plane=id_plane, xp)
sample_points_df_plane<- merge.data.frame(xp,yp, by= "id_plane")

distance_Risk_random_plane<- sqrt((sample_points_df_plane$value.x)^2 + (sample_points_df_plane$value.y)^2) #Finding points distance from index point 
sample_points_df_plane$distance_from_index <- distance_Risk_random_plane #Create new Dataframe of just distance from Index case

Cumalitve_risk_plane<- as.numeric(lapply(sample_points_df_plane[ ,4], calcRisk))  #Find Risk for each point 
Cumalitve_risk_plane<- sum(Cumalitve_risk_plane)/10 #Average Risks 
Cumalitve_distance_plane<- mean(sample_points_df_plane$distance_from_index)#Average Distances for points

Risk_plane = Cumalitve_risk_plane # Reassign the static risk measure to the cumplative risk for all susceptible persons 
```

Now that we have the parameters indicated for the scenarios we want to test we will find the preliminary beta coefficients 
```{r}

```

